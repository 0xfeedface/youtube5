<!DOCTYPE html><html><head><title>YouTube5</title><script>

/*
YouTube5 Copyright 2010 Connor McKay

YouTube5 is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

YouTube5 is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.
*/

// inspired by http://userscripts.org/scripts/review/25105
function findVideoSrc(pageSrc) {
    var videoId = pageSrc.match(/\&video_id=([^(\&|$)]*)/)[1];
    var videoTicket = pageSrc.match(/\&t=([^(\&|$)]*)/)[1];
    var videoFormats = pageSrc.match(/\&fmt_url_map=([^(\&|$)]*)/)[1];
    
    var validFormats = [18, 22, 37];
    var formats = videoFormats.match(/\d+(?=%7C)/g);
    var availableFormats = [18];
    formats.forEach(function(format) {
        format = parseInt(format, 10);
        if (validFormats.indexOf(format) !== -1) {
            availableFormats.push(format);
        }
    });
    
    var format = safari.extension.settings.largestFormat;
    if (availableFormats.indexOf(format) === -1) {
        availableFormats.sort();
        format = availableFormats[availableFormats.length - 1];
    }
    
    return "http://www.youtube.com/get_video?fmt=" + format + "&asv=2&video_id=" + videoId + "&t=" + videoTicket;
}

function loadVideo(event) {
    var video = event.message;
    var req = new XMLHttpRequest();
    req.open('GET', 'http://www.youtube.com/watch?v=' + video.id, true);
    req.onreadystatechange = function(ev) {
        if (req.readyState === 4 && req.status === 200) {
            video.src = findVideoSrc(req.responseText);
            event.target.page.dispatchMessage("injectVideo", video);
        }
    };
    req.send(null);
}

safari.application.addEventListener("message", function(event) {
    if (event.name == "loadVideo") {
        loadVideo(event);
    }
}, false);

</script></head><body></body></html>