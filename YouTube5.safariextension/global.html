<!DOCTYPE html>
<html>
<head>
<title>Youtube5</title>
<script>
// inspired by http://userscripts.org/scripts/review/25105
function findVideoSrc(pageSrc) {
    var videoId = pageSrc.match(/\&video_id=([^(\&|$)]*)/)[1];
    var videoTicket = pageSrc.match(/\&t=([^(\&|$)]*)/)[1];
    var videoFormats = pageSrc.match(/\&fmt_url_map=([^(\&|$)]*)/)[1];
    
    var validFormats = [18, 22, 37];
    var formats = videoFormats.match(/\d+(?=%7C)/g);
    var availableFormats = [18];
    formats.forEach(function(format) {
        format = parseInt(format);
        if (validFormats.indexOf(format) !== -1) {
            availableFormats.push(format);
        }
    });
    
    var format = safari.extension.settings.largestFormat;
    if (availableFormats.indexOf(format) === -1) {
		availableFormats.sort();
        format = availableFormats[availableFormats.length - 1];
    }
    
    return "http://www.youtube.com/get_video?fmt=" + format + "&video_id=" + videoId + "&t=" + videoTicket
}

function loadVideo(event) {
	var video = event.message;
	var req = new XMLHttpRequest();
	req.open('GET', 'http://www.youtube.com/watch?v=' + video.id, true);
	req.onreadystatechange = function(ev) {
	    if (req.readyState === 4 && req.status === 200) {
	        video.src = findVideoSrc(req.responseText);
			event.target.page.dispatchMessage("injectVideo", video);
	    }
	};
	req.send(null);
}

safari.application.addEventListener("message", function(event) {
	if (event.name == "loadVideo") {
		loadVideo(event);
	}
}, false);
</script>
</head>
<body>
</body>
</html>